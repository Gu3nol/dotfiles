#!/usr/bin/python
# -*- coding:Utf-8 -*-

import sys
import os

# program argument
try:
    image_filename  = sys.argv[1]
    header_filename = sys.argv[2]
except:
    print "Usage ", sys.argv[0], " image header"
    sys.exit(-1)

header_basename = os.path.splitext(header_filename)[0]
header_basename = os.path.basename(header_basename)

# files
try:
    image  = open(image_filename,'r')
    header = open(header_filename,'w')
except:
    print "Impossible d'ouvrire les fichiers"
    sys.exit(-1)

# read the image file header
h = [];
while (len(h)!= 4):
    line = image.readline()
    if (line[0]!='#'):h = h + line.split()

image_format = h[0]
width  = int(h[1])
height = int(h[2])
max    = int(h[3])

if image_format != 'P2' :
    print "l'image n'est pas au format pgm ascii"
    sys.exit(-1)

#print "Image pgm de", width, "x", height
#print " -> d'intensitÃ© max ", max

header.write( "#ifndef "+ header_basename.upper() +"_H\n" )
header.write( "#define "+ header_basename.upper() +"_H\n\n" )
header.write( "#define "+ header_basename +"_width  " + str(width) + "\n" )
header.write( "#define "+ header_basename +"_height " + str(height)+ "\n\n" )
header.write( "static unsigned char "+ header_basename +"_image[] = {\n\t"  )

p_num = 0
for line in image:
   for pixel in line.split():
      header.write("0x%02x, "%int(pixel))
      p_num = p_num +1
      if  p_num%16 == 0 : header.write("\n\t")

if  p_num%16 != 0 : header.write("\n")
header.write( "};\n\n")
header.write( "#endif //"+ header_basename.upper()+"_H\n")

image.close()
header.close()
