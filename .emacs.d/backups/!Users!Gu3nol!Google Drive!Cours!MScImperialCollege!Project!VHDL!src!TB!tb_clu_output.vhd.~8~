---------------------------------------------------------
-- Testbench for the Top level Control Logic Unit
-- tb_clu.vhd
-- MSc Project 2015
-- @Author: Guénolé LALLEMENT

-- This VHDL code is implemented on-chip using
-- the Cadence Encounter tool

-- It is developed for an 8x8 hexagonal pixel array
-- and characterisation array
--------------------------------------------------------

LIBRARY IEEE;

USE IEEE.std_logic_1164.ALL;
USE IEEE.numeric_std.ALL;
USE work.clu_pack.ALL;
USE work.ALL;

ENTITY tb_clu_output IS
  PORT(
    -- Master input clock
    mclk     : OUT std_logic;
    -- SPI in
    din      : OUT std_logic_vector(15 DOWNTO 0);
    -- ADC
    adc_eoc  : OUT std_logic;
    adc_data : OUT std_logic_vector(9 DOWNTO 0)
    );
END tb_clu_output;

ARCHITECTURE behav OF tb_clu_output IS

  SIGNAL op_cmd_i      : slv(1 DOWNTO 0);
  SIGNAL array_coord_i : slv(5 DOWNTO 0);
  SIGNAL anag_coord_i  : slv(3 DOWNTO 0);

  CONSTANT zero_pad : slv(3 DOWNTO 0) := (OTHERS => '0');

BEGIN

  -- Master clock generation
  clkgen : PROCESS
  BEGIN
    mclk <= '0';
    WAIT FOR 500 ns;
    mclk <= '1';
    WAIT FOR 500 ns;
  END PROCESS clkgen;

  -- nReset generation
  nrstgen : PROCESS
  BEGIN
    WAIT FOR 10 ns;
    op_cmd_i <= op_reset;
    WAIT FOR 1700 ns;
    op_cmd_i <= op_reset;
    WAIT FOR 2000 ns;
    op_cmd_i <= op_stop;
    WAIT FOR 10 us;
    op_cmd_i <= op_reset;
    WAIT FOR 1 us;
    op_cmd_i <= op_start;
    WAIT FOR 50 us;
    op_cmd_i <= op_reset;
    WAIT FOR 2000 ns;
    REPORT "All tests finished OK, terminating with failure ASSERT."
      SEVERITY failure;
  END PROCESS nrstgen;

  -- Signal generation
  siggen : PROCESS
  BEGIN
    din           <= zero_pad & anag_coord_i & op_cmd_i & array_coord_i;
    WAIT FOR 500 ns;
    anag_coord_i  <= "0000";
    array_coord_i <= (OTHERS => '0');


    adc_eoc  <= '0';
    adc_data <= (OTHERS => '0');
    din      <= zero_pad & anag_coord_i & op_cmd_i & array_coord_i;
    WAIT FOR 500 ns;
    din      <= zero_pad & anag_coord_i & op_cmd_i & array_coord_i;


    FOR i IN 0 TO 63 LOOP
      WAIT FOR 500 ns;
      op_cmd_i      <= op_start;
      array_coord_i <= slv(to_unsigned(i, array_coord_i'length));
      din           <= zero_pad & anag_coord_i & op_cmd_i & array_coord_i;
    END LOOP;

    FOR i IN 0 TO 12 LOOP
      WAIT FOR 500 ns;
      array_coord_i <= (OTHERS => '0');
      anag_coord_i  <= slv(to_unsigned(i, anag_coord_i'length));
      din           <= zero_pad & anag_coord_i & op_cmd_i & array_coord_i;
    END LOOP;

    WAIT FOR 500 ns;
    array_coord_i <= slv(to_unsigned(1, array_coord_i'length));
    din           <= zero_pad & anag_coord_i & op_cmd_i & array_coord_i;

  END PROCESS siggen;

END behav;
